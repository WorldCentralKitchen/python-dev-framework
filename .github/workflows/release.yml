name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.0)"
        required: true

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF_NAME:-${{ github.event.inputs.tag }}}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Verify tag matches plugin version
        run: |
          PLUGIN_VERSION=$(jq -r .version .claude-plugin/plugin.json)
          EXPECTED_TAG="v${PLUGIN_VERSION}"
          if [ "${{ steps.version.outputs.tag }}" != "$EXPECTED_TAG" ]; then
            echo "::error::Tag ${{ steps.version.outputs.tag }} does not match plugin.json version $PLUGIN_VERSION"
            exit 1
          fi

      - name: Extract changelog section
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body: ${{ steps.changelog.outputs.notes }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-marketplace:
    name: Sync Plugin to Marketplace
    runs-on: ubuntu-latest
    needs: release
    # Only update marketplace for stable releases (not prereleases)
    if: ${{ !contains(github.ref_name || github.event.inputs.tag, '-') }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF_NAME:-${{ github.event.inputs.tag }}}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Checkout plugin repo
        uses: actions/checkout@v4
        with:
          path: plugin

      - name: Checkout marketplace repo
        uses: actions/checkout@v4
        with:
          repository: WorldCentralKitchen/wck-claude-plugins
          token: ${{ secrets.MARKETPLACE_PAT }}
          path: marketplace

      - name: Sync plugin essentials to marketplace
        run: |
          cd marketplace
          rm -rf plugins/python-dev-framework
          mkdir -p plugins/python-dev-framework

          # Copy plugin essentials (hooks/skills at root level, not inside .claude-plugin)
          cp -r $GITHUB_WORKSPACE/plugin/.claude-plugin plugins/python-dev-framework/
          cp -r $GITHUB_WORKSPACE/plugin/hooks plugins/python-dev-framework/
          cp -r $GITHUB_WORKSPACE/plugin/skills plugins/python-dev-framework/
          cp $GITHUB_WORKSPACE/plugin/CLAUDE.md plugins/python-dev-framework/
          cp $GITHUB_WORKSPACE/plugin/.lsp.json plugins/python-dev-framework/ 2>/dev/null || true

          # Remove symlinks (they don't work in marketplace context)
          rm -f plugins/python-dev-framework/.claude-plugin/hooks
          rm -f plugins/python-dev-framework/.claude-plugin/skills

          # Generate stub README
          cat > plugins/python-dev-framework/README.md << 'EOF'
          # python-dev-framework

          This is a distribution copy. For full documentation and development:
          - **Source repo**: https://github.com/WorldCentralKitchen/python-dev-framework
          - **Deployment process**: See [marketplace README](../../README.md)
          EOF

      - name: Update marketplace.json
        run: |
          cd marketplace
          PLUGIN_NAME="python-dev-framework"
          VERSION="${{ steps.version.outputs.version }}"

          # Check if plugin exists in marketplace.json
          if jq -e ".plugins[] | select(.name == \"$PLUGIN_NAME\")" .claude-plugin/marketplace.json > /dev/null 2>&1; then
            # Update existing entry
            jq "(.plugins[] | select(.name == \"$PLUGIN_NAME\")).version = \"$VERSION\"" \
              .claude-plugin/marketplace.json > tmp.json && mv tmp.json .claude-plugin/marketplace.json
          else
            # Add new entry
            jq ".plugins += [{
              \"name\": \"$PLUGIN_NAME\",
              \"source\": \"./plugins/$PLUGIN_NAME\",
              \"description\": \"Opinionated Python development enforcement for Claude Code\",
              \"version\": \"$VERSION\"
            }]" .claude-plugin/marketplace.json > tmp.json && mv tmp.json .claude-plugin/marketplace.json
          fi

      - name: Create PR on marketplace
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MARKETPLACE_PAT }}
          path: marketplace
          branch: update-python-dev-framework-${{ steps.version.outputs.tag }}
          title: "chore: update python-dev-framework to ${{ steps.version.outputs.tag }}"
          body: |
            Automated PR to update python-dev-framework version and sync plugin files.

            **Release:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}
            **Changelog:** ${{ github.server_url }}/${{ github.repository }}/blob/main/CHANGELOG.md

            ### Files synced
            - `.claude-plugin/`
            - `hooks/`
            - `skills/`
            - `CLAUDE.md`
            - `.lsp.json`
          commit-message: "chore: update python-dev-framework to ${{ steps.version.outputs.tag }}"
